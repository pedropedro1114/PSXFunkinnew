name: "Build PSXFunkin - Complete Version"

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: "Tipo de build"
        required: true
        default: "full"
        type: choice
        options:
          - "full"
          - "code_only"

jobs:
  build-psx:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    # PASO 1: Obtener cÃ³digo
    - name: "Checkout repository"
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    # PASO 2: Verificar estructura del proyecto
    - name: "Analyze project structure"
      run: |
        echo "=== ESTRUCTURA DEL PROYECTO ==="
        ls -la
        echo ""
        find . -name "Makefile*" -type f
        echo ""
        find . -name "*.c" -o -name "*.h" | head -10
        echo ""
        find tools -type f 2>/dev/null | head -10 || echo "No hay herramientas"
        echo ""
        find assets -type f 2>/dev/null | head -10 || echo "No hay assets"

    # PASO 3: Instalar todas las dependencias
    - name: "Install all dependencies"
      run: |
        echo "=== INSTALANDO DEPENDENCIAS COMPLETAS ==="
        sudo apt-get update
        sudo apt-get install -y build-essential make cmake ninja-build
        sudo apt-get install -y git wget curl apt-utils
        sudo apt-get install -y tar gzip unzip p7zip-full
        sudo apt-get install -y mkisofs genisoimage
        sudo apt-get install -y imagemagick ffmpeg libavcodec-extra
        sudo apt-get install -y libpng-dev libjpeg-dev libwebp-dev
        sudo apt-get install -y libsdl2-dev libsdl2-mixer-dev
        sudo apt-get install -y gcc-mipsel-linux-gnu binutils-mipsel-linux-gnu
        sudo apt-get install -y g++-mipsel-linux-gnu
        sudo apt-get install -y flex bison texinfo
        sudo apt-get install -y libgmp-dev libmpfr-dev libmpc-dev
        sudo apt-get install -y autoconf automake libtool pkg-config

    # PASO 4: Instalar PSXSDK desde source
    - name: "Install PSXSDK from source"
      run: |
        echo "=== INSTALANDO PSXSDK ==="
        git clone --depth 1 https://github.com/psxdev/psxsdk.git
        cd psxsdk
        make -j4
        sudo make install
        cd ..
        export PSXSDK=/usr/local/psxsdk
        export PATH=/usr/local/psxsdk/bin:$PATH
        echo "PSXSDK=/usr/local/psxsdk" >> $GITHUB_ENV
        echo "PATH=/usr/local/psxsdk/bin:$PATH" >> $GITHUB_ENV

    # PASO 5: Compilar todas las herramientas
    - name: "Build all tools"
      run: |
        echo "=== COMPILANDO HERRAMIENTAS ==="
        mkdir -p tools
        for c_file in tools/*.c; do
          if [ -f "$c_file" ]; then
            tool_name=$(basename "$c_file" .c)
            echo "Compilando $tool_name..."
            gcc -O2 -lm "$c_file" -o "tools/$tool_name"
            if [ $? -eq 0 ]; then
              chmod +x "tools/$tool_name"
              echo "âœ… $tool_name compilado"
            fi
          fi
        done
        for cpp_file in tools/*.cpp; do
          if [ -f "$cpp_file" ]; then
            tool_name=$(basename "$cpp_file" .cpp)
            echo "Compilando $tool_name (C++)..."
            g++ -O2 -lm "$cpp_file" -o "tools/$tool_name"
            if [ $? -eq 0 ]; then
              chmod +x "tools/$tool_name"
              echo "âœ… $tool_name compilado"
            fi
          fi
        done

    # PASO 6: Procesar assets grÃ¡ficos y de audio
    - name: "Process graphics and audio assets"
      id: process_assets
      run: |
        echo "=== PROCESANDO ASSETS ==="
        mkdir -p iso/ASSETS
        
        # Solo procesar assets si build_type es 'full'
        if [ "${{ github.event.inputs.build_type }}" = "full" ]; then
          echo "Procesando assets (modo full)..."
          
          echo "Buscando assets grÃ¡ficos..."
          for img_file in $(find . -name "*.png" -type f | head -20); do
            filename=$(basename "$img_file" .png)
            echo "Convirtiendo: $filename.png"
            if [ -f "tools/funkintimpak" ]; then
              tools/funkintimpak "$img_file" "iso/ASSETS/${filename}.TIM"
            elif [ -f "tools/img2tim" ]; then
              tools/img2tim "$img_file" "iso/ASSETS/${filename}.TIM"
            else
              convert "$img_file" -resize 256x256! "iso/ASSETS/${filename}.TIM" 2>/dev/null || true
            fi
          done
          
          echo "Buscando assets de audio..."
          for audio_file in $(find . -name "*.wav" -type f | head -20); do
            filename=$(basename "$audio_file" .wav)
            echo "Convirtiendo: $filename.wav"
            if [ -f "tools/vagconv" ]; then
              tools/vagconv "$audio_file" "iso/ASSETS/${filename}.VAG"
            else
              ffmpeg -i "$audio_file" -acodec pcm_s16le -ar 22050 -ac 2 "iso/ASSETS/${filename}.VAG" 2>/dev/null || true
            fi
          done
        else
          echo "Saltando procesamiento de assets (modo code_only)"
        fi
        
        # Crear assets bÃ¡sicos si no hay ninguno
        if [ ! "$(ls -A iso/ASSETS)" ]; then
          echo "Creando assets bÃ¡sicos..."
          echo "BASIC_ASSET" > iso/ASSETS/placeholder.TIM
          echo "BASIC_AUDIO" > iso/ASSETS/placeholder.VAG
        fi

    # PASO 7: Compilar el juego principal
    - name: "Compile main game"
      run: |
        echo "=== COMPILANDO JUEGO PRINCIPAL ==="
        export PSXSDK=/usr/local/psxsdk
        export PATH=/usr/local/psxsdk/bin:$PATH
        
        echo "Verificando librerÃ­as PSX..."
        if [ -f "/usr/local/psxsdk/include/libetc.h" ]; then
          echo "âœ… libetc.h encontrado"
        else
          echo "âš ï¸ libetc.h no encontrado"
        fi
        
        echo "Iniciando compilaciÃ³n..."
        if [ -f "Makefile.psx" ]; then
          echo "Usando Makefile.psx..."
          make -f Makefile.psx clean
          make -f Makefile.psx -j4
        fi
        
        if [ ! -f "PSXFNKN.BIN" ] && [ -f "Makefile" ]; then
          echo "Usando Makefile principal..."
          make clean
          make -j4
        fi
        
        echo "Resultados de compilaciÃ³n:"
        if [ -f "PSXFNKN.BIN" ]; then
          echo "âœ… PSXFNKN.BIN creado exitosamente!"
          ls -lh PSXFNKN.BIN
        else
          echo "âŒ PSXFNKN.BIN no se creÃ³"
          find . -name "*.BIN" -o -name "*.bin" -o -name "*.ELF" | head -10
        fi

    # PASO 8: Preparar estructura final de ISO
    - name: "Prepare final ISO structure"
      run: |
        echo "=== PREPARANDO ESTRUCTURA ISO ==="
        
        if [ -f "PSXFNKN.BIN" ]; then
          cp PSXFNKN.BIN iso/PSXFNKN.BIN
          echo "âœ… PSXFNKN.BIN copiado a ISO"
        else
          echo "âš ï¸ No hay PSXFNKN.BIN, creando placeholder..."
          dd if=/dev/zero of=iso/PSXFNKN.BIN bs=1024 count=100
        fi
        
        echo "Creando SYSTEM.CNF..."
        cat > iso/SYSTEM.CNF << 'SYSTEM_CNF'
BOOT = cdrom:\PSXFNKN.BIN;1
TCB = 4
EVENT = 10
STACK = 801FFFF0
SYSTEM_CNF
        
        echo "Estructura final de ISO:"
        find iso/ -type f

    # PASO 9: Crear imagen ISO booteable
    - name: "Create bootable PSX ISO"
      run: |
        echo "=== CREANDO IMAGEN ISO ==="
        
        echo "Generando ISO..."
        mkisofs -o PSXFunkin.iso \
          -sysid "PLAYSTATION" \
          -volid "PSXFNKN" \
          -V "PSXFNKN" \
          -J -r -l -quiet \
          iso/
        
        if [ -f "PSXFunkin.iso" ]; then
          echo "ðŸŽ‰ âœ… ISO CREADO EXITOSAMENTE!"
          ls -lh PSXFunkin.iso
          echo "TamaÃ±o: $(du -h PSXFunkin.iso | cut -f1)"
        else
          echo "âŒ ERROR: No se pudo crear el ISO"
          exit 1
        fi

    # PASO 10: VerificaciÃ³n final y reporte
    - name: "Final verification and report"
      run: |
        echo "=== VERIFICACIÃ“N FINAL ==="
        echo ""
        echo "ðŸŽ¯ BUILD COMPLETADO - PSXFUNKIN"
        echo "================================"
        echo ""
        echo "ðŸ“¦ ARCHIVOS GENERADOS:"
        echo "   â€¢ PSXFunkin.iso (Imagen PSX booteable)"
        if [ -f "PSXFNKN.BIN" ]; then
          echo "   â€¢ PSXFNKN.BIN (Ejecutable principal)"
        fi
        echo "   â€¢ iso/SYSTEM.CNF (ConfiguraciÃ³n boot)"
        echo "   â€¢ iso/ASSETS/ (Assets del juego)"
        echo ""
        echo "ðŸ“Š ESTADÃSTICAS:"
        echo "   â€¢ Assets TIM: $(find iso/ASSETS -name "*.TIM" | wc -l)"
        echo "   â€¢ Assets VAG: $(find iso/ASSETS -name "*.VAG" | wc -l)"
        echo "   â€¢ TamaÃ±o ISO: $(du -h PSXFunkin.iso | cut -f1)"
        echo ""
        echo "ðŸš€ INSTRUCCIONES:"
        echo "   1. Descarga el artifact 'psx-funkin-complete'"
        echo "   2. Usa PSXFunkin.iso en DuckStation, ePSXe, etc."
        echo "   3. Â¡Disfruta de Friday Night Funkin en PSX!"

    # PASO 11: Subir todos los artifacts
    - name: "Upload all artifacts"
      uses: actions/upload-artifact@v4
      with:
        name: psx-funkin-complete
        path: |
          PSXFunkin.iso
          *.BIN
          *.ELF
          iso/
        retention-days: 30
