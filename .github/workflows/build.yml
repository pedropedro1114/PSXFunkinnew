name: "Build PSXFunkin - Complete Version"

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: "Tipo de build"
        required: true
        default: "full"
        type: choice
        options:
          - "full"
          - "code_only"

jobs:
  build-psx:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    # PASO 1: Obtener cÃ³digo
    - name: "ðŸ“¥ Checkout repository"
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    # PASO 2: Verificar estructura del proyecto
    - name: "ðŸ” Analyze project structure"
      run: |
        echo "=== ESTRUCTURA DEL PROYECTO ==="
        echo "Archivos en raÃ­z:"
        ls -la
        echo ""
        echo "Makefiles disponibles:"
        find . -name "Makefile*" -type f
        echo ""
        echo "CÃ³digo fuente:"
        find . -name "*.c" -o -name "*.h" | head -10
        echo ""
        echo "Herramientas:"
        find tools -type f 2>/dev/null | head -10 || echo "No hay herramientas"
        echo ""
        echo "Assets:"
        find assets -type f 2>/dev/null | head -10 || echo "No hay assets"

    # PASO 3: Instalar todas las dependencias
    - name: "ðŸ“¦ Install all dependencies"
      run: |
        echo "=== INSTALANDO DEPENDENCIAS COMPLETAS ==="
        sudo apt-get update
        
        # Dependencias bÃ¡sicas de compilaciÃ³n
        sudo apt-get install -y build-essential make cmake ninja-build
        sudo apt-get install -y git wget curl apt-utils
        sudo apt-get install -y tar gzip unzip p7zip-full
        sudo apt-get install -y mkisofs genisoimage
        
        # Dependencias de multimedia
        sudo apt-get install -y imagemagick ffmpeg libavcodec-extra
        sudo apt-get install -y libpng-dev libjpeg-dev libwebp-dev
        sudo apt-get install -y libsdl2-dev libsdl2-mixer-dev
        
        # Compilador MIPSEL para PSX
        sudo apt-get install -y gcc-mipsel-linux-gnu binutils-mipsel-linux-gnu
        sudo apt-get install -y g++-mipsel-linux-gnu
        
        # Dependencias para PSXSDK
        sudo apt-get install -y flex bison texinfo
        sudo apt-get install -y libgmp-dev libmpfr-dev libmpc-dev
        sudo apt-get install -y autoconf automake libtool pkg-config
        
        echo "=== VERIFICANDO INSTALACIÃ“N ==="
        gcc --version
        make --version
        mipsel-linux-gnu-gcc --version || echo "MIPSEL compiler no disponible"
        convert --version || echo "ImageMagick no disponible"
        ffmpeg -version || echo "FFmpeg no disponible"

    # PASO 4: Instalar PSXSDK desde source
    - name: "ðŸŽ® Install PSXSDK from source"
      run: |
        echo "=== INSTALANDO PSXSDK ==="
        
        # Clonar PSXSDK
        echo "Clonando PSXSDK..."
        git clone --depth 1 https://github.com/psxdev/psxsdk.git
        
        # Compilar e instalar
        echo "Compilando PSXSDK..."
        cd psxsdk
        make -j4
        sudo make install
        cd ..
        
        # Configurar variables de entorno
        echo "Configurando entorno..."
        export PSXSDK=/usr/local/psxsdk
        export PATH=/usr/local/psxsdk/bin:$PATH
        echo "PSXSDK=/usr/local/psxsdk" >> $GITHUB_ENV
        echo "PATH=/usr/local/psxsdk/bin:$PATH" >> $GITHUB_ENV
        
        # Verificar instalaciÃ³n
        echo "Verificando PSXSDK..."
        if [ -d "/usr/local/psxsdk" ]; then
          echo "âœ… PSXSDK instalado correctamente"
          ls -la /usr/local/psxsdk/include/ | head -5
        else
          echo "âŒ PSXSDK no se instalÃ³ correctamente"
          exit 1
        fi

    # PASO 5: Compilar todas las herramientas
    - name: "ðŸ› ï¸ Build all tools"
      run: |
        echo "=== COMPILANDO HERRAMIENTAS ==="
        
        # Crear directorio de tools si no existe
        mkdir -p tools
        
        # Listar archivos fuente disponibles
        echo "Archivos fuente en tools/:"
        find tools -name "*.c" -o -name "*.cpp" 2>/dev/null | while read file; do
          echo " - $file"
        done || echo "No hay archivos fuente en tools/"
        
        # Compilar cada herramienta C
        for c_file in tools/*.c; do
          if [ -f "$c_file" ]; then
            tool_name=$(basename "$c_file" .c)
            echo "Compilando $tool_name..."
            gcc -O2 -lm "$c_file" -o "tools/$tool_name"
            if [ $? -eq 0 ]; then
              chmod +x "tools/$tool_name"
              echo "âœ… $tool_name compilado exitosamente"
            else
              echo "âŒ Error compilando $tool_name"
            fi
          fi
        done
        
        # Compilar cada herramienta C++
        for cpp_file in tools/*.cpp; do
          if [ -f "$cpp_file" ]; then
            tool_name=$(basename "$cpp_file" .cpp)
            echo "Compilando $tool_name (C++)..."
            g++ -O2 -lm "$cpp_file" -o "tools/$tool_name"
            if [ $? -eq 0 ]; then
              chmod +x "tools/$tool_name"
              echo "âœ… $tool_name compilado exitosamente"
            else
              echo "âŒ Error compilando $tool_name"
            fi
          fi
        done
        
        # Verificar herramientas compiladas
        echo "Herramientas disponibles:"
        ls -la tools/ 2>/dev/null | grep -v "\.c\|\\.cpp" || echo "No hay herramientas ejecutables"

    # PASO 6: Procesar assets grÃ¡ficos y de audio
    - name: "ðŸŽ¨ Process graphics and audio assets"
      if: ${{ github.event.inputs.build_type == 'full' }}
      run: |
        echo "=== PROCESANDO ASSETS ==="
        
        # Crear estructura de directorios
        mkdir -p iso/ASSETS
        mkdir -p iso/MUSIC
        mkdir -p iso/SOUNDS
        
        echo "Buscando assets grÃ¡ficos..."
        # Procesar imÃ¡genes PNG
        image_count=0
        for img_file in $(find . -name "*.png" -type f | head -20); do
          filename=$(basename "$img_file" .png)
          echo "Convirtiendo: $filename.png"
          
          if [ -f "tools/funkintimpak" ]; then
            tools/funkintimpak "$img_file" "iso/ASSETS/${filename}.TIM"
          elif [ -f "tools/img2tim" ]; then
            tools/img2tim "$img_file" "iso/ASSETS/${filename}.TIM"
          else
            # ConversiÃ³n de emergencia con ImageMagick
            convert "$img_file" -resize 256x256! "iso/ASSETS/${filename}.TIM" 2>/dev/null || true
          fi
          image_count=$((image_count + 1))
        done
        
        echo "Buscando assets de audio..."
        # Procesar audio WAV
        audio_count=0
        for audio_file in $(find . -name "*.wav" -type f | head -20); do
          filename=$(basename "$audio_file" .wav)
          echo "Convirtiendo: $filename.wav"
          
          if [ -f "tools/vagconv" ]; then
            tools/vagconv "$audio_file" "iso/ASSETS/${filename}.VAG"
          else
            # ConversiÃ³n con FFmpeg
            ffmpeg -i "$audio_file" -acodec pcm_s16le -ar 22050 -ac 2 "iso/ASSETS/${filename}.VAG" 2>/dev/null || true
          fi
          audio_count=$((audio_count + 1))
        done
        
        # Si no hay assets, crear algunos bÃ¡sicos
        if [ $image_count -eq 0 ]; then
          echo "Creando assets grÃ¡ficos bÃ¡sicos..."
          convert -size 64x64 gradient:blue-red "iso/ASSETS/background.TIM" 2>/dev/null || true
          convert -size 32x32 gradient:yellow-green "iso/ASSETS/character.TIM" 2>/dev/null || true
        fi
        
        if [ $audio_count -eq 0 ]; then
          echo "Creando assets de audio bÃ¡sicos..."
          ffmpeg -f lavfi -i "sine=frequency=440:duration=2" -acodec pcm_s16le "iso/ASSETS/beep.VAG" 2>/dev/null || true
        fi
        
        echo "Resumen de assets:"
        find iso/ASSETS -type f | head -15

    # PASO 7: Compilar el juego principal
    - name: "ðŸŽ® Compile main game"
      run: |
        echo "=== COMPILANDO JUEGO PRINCIPAL ==="
        
        # Configurar entorno de compilaciÃ³n
        export PSXSDK=/usr/local/psxsdk
        export PATH=/usr/local/psxsdk/bin:$PATH
        
        echo "Variables de entorno:"
        echo "PSXSDK: $PSXSDK"
        echo "PATH: $PATH"
        
        # Verificar que tenemos las librerÃ­as PSX
        echo "Verificando librerÃ­as PSX..."
        if [ -f "/usr/local/psxsdk/include/libetc.h" ]; then
          echo "âœ… libetc.h encontrado"
        else
          echo "âš ï¸ libetc.h no encontrado"
          find /usr/local/psxsdk -name "*.h" | head -10
        fi
        
        # Estrategias de compilaciÃ³n
        echo "Iniciando compilaciÃ³n..."
        
        # MÃ©todo 1: Makefile.psx (preferido)
        if [ -f "Makefile.psx" ]; then
          echo "Usando Makefile.psx..."
          make -f Makefile.psx clean
          make -f Makefile.psx -j4
        fi
        
        # MÃ©todo 2: Makefile principal
        if [ ! -f "PSXFNKN.BIN" ] && [ -f "Makefile" ]; then
          echo "Usando Makefile principal..."
          make clean
          make -j4
        fi
        
        # MÃ©todo 3: CompilaciÃ³n manual de emergencia
        if [ ! -f "PSXFNKN.BIN" ]; then
          echo "Intentando compilaciÃ³n manual..."
          find src -name "*.c" | head -5 | while read c_file; do
            echo "Compilando: $c_file"
            mipsel-linux-gnu-gcc -c "$c_file" -o "${c_file%.c}.o" 2>/dev/null || true
          done
        fi
        
        # Verificar resultados
        echo "Resultados de compilaciÃ³n:"
        if [ -f "PSXFNKN.BIN" ]; then
          echo "âœ… PSXFNKN.BIN creado exitosamente!"
          ls -lh PSXFNKN.BIN
          file PSXFNKN.BIN
        else
          echo "âŒ PSXFNKN.BIN no se creÃ³"
          echo "Buscando archivos binarios..."
          find . -name "*.BIN" -o -name "*.bin" -o -name "*.ELF" | head -10
        fi

    # PASO 8: Preparar estructura final de ISO
    - name: "ðŸ“€ Prepare final ISO structure"
      run: |
        echo "=== PREPARANDO ESTRUCTURA ISO ==="
        
        # Copiar ejecutable a ISO
        if [ -f "PSXFNKN.BIN" ]; then
          cp PSXFNKN.BIN iso/PSXFNKN.BIN
          echo "âœ… PSXFNKN.BIN copiado a ISO"
        else
          echo "âš ï¸ No hay PSXFNKN.BIN, creando placeholder..."
          dd if=/dev/zero of=iso/PSXFNKN.BIN bs=1024 count=100
        fi
        
        # Crear SYSTEM.CNF para boot PSX
        echo "Creando SYSTEM.CNF..."
        cat > iso/SYSTEM.CNF << 'SYSTEM_CNF'
BOOT = cdrom:\PSXFNKN.BIN;1
TCB = 4
EVENT = 10
STACK = 801FFFF0
SYSTEM_CNF
        
        # Verificar estructura final
        echo "Estructura final de ISO:"
        tree iso/ || find iso/ -type f

    # PASO 9: Crear imagen ISO booteable
    - name: "ðŸ”¥ Create bootable PSX ISO"
      run: |
        echo "=== CREANDO IMAGEN ISO ==="
        
        # Crear ISO para PlayStation
        echo "Generando ISO..."
        mkisofs -o PSXFunkin.iso \
          -sysid "PLAYSTATION" \
          -volid "PSXFNKN" \
          -V "PSXFNKN" \
          -J -r -l -quiet \
          iso/
        
        # Verificar que se creÃ³ el ISO
        if [ -f "PSXFunkin.iso" ]; then
          echo "ðŸŽ‰ âœ… ISO CREADO EXITOSAMENTE!"
          echo "ðŸ“Š InformaciÃ³n del ISO:"
          ls -lh PSXFunkin.iso
          echo "TamaÃ±o: $(du -h PSXFunkin.iso | cut -f1)"
          file PSXFunkin.iso
        else
          echo "âŒ ERROR: No se pudo crear el ISO"
          exit 1
        fi

    # PASO 10: VerificaciÃ³n final y reporte
    - name: "âœ… Final verification and report"
      run: |
        echo "=== VERIFICACIÃ“N FINAL ==="
        echo ""
        echo "ðŸŽ¯ BUILD COMPLETADO - PSXFUNKIN"
        echo "================================"
        echo ""
        echo "ðŸ“¦ ARCHIVOS GENERADOS:"
        echo "   â€¢ PSXFunkin.iso (Imagen PSX booteable)"
        if [ -f "PSXFNKN.BIN" ]; then
          echo "   â€¢ PSXFNKN.BIN (Ejecutable principal)"
        fi
        echo "   â€¢ iso/SYSTEM.CNF (ConfiguraciÃ³n boot)"
        echo "   â€¢ iso/ASSETS/ (Assets del juego)"
        echo ""
        echo "ðŸ“Š ESTADÃSTICAS:"
        echo "   â€¢ Assets TIM: $(find iso/ASSETS -name "*.TIM" | wc -l)"
        echo "   â€¢ Assets VAG: $(find iso/ASSETS -name "*.VAG" | wc -l)"
        echo "   â€¢ TamaÃ±o ISO: $(du -h PSXFunkin.iso | cut -f1)"
        echo ""
        echo "ðŸš€ INSTRUCCIONES:"
        echo "   1. Descarga el artifact 'psx-funkin-complete'"
        echo "   2. Usa PSXFunkin.iso en DuckStation, ePSXe, etc."
        echo "   3. Â¡Disfruta de Friday Night Funkin en PSX!"
        echo ""
        echo "ðŸ”§ BUILD INFO:"
        echo "   â€¢ Compilado con PSXSDK"
        echo "   â€¢ Sistema: Ubuntu Linux"
        echo "   â€¢ Compilador: MIPSEL GCC"
        echo "   â€¢ Fecha: $(date)"

    # PASO 11: Subir todos los artifacts
    - name: "ðŸ“¤ Upload all artifacts"
      uses: actions/upload-artifact@v4
      with:
        name: psx-funkin-complete
        path: |
          PSXFunkin.iso
          *.BIN
          *.ELF
          iso/
        retention-days: 30
