name: ðŸŽ® Build PSXFunkin - OFFICIAL

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Tipo de build'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - code_only

jobs:
  build-psx:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
    # PASO 1: Obtener cÃ³digo
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    # PASO 2: Instalar PSXSDK (como dice COMPILE.md)
    - name: ðŸ› ï¸ Install PSXSDK
      run: |
        echo "ðŸ› ï¸ INSTALANDO PSXSDK (Official)..."
        
        # Instalar dependencias para PSXSDK
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          make \
          cmake \
          git \
          wget \
          curl \
          tar \
          gzip \
          unzip \
          mkisofs \
          imagemagick \
          ffmpeg \
          libpng-dev \
          libjpeg-dev \
          gcc-mipsel-linux-gnu \
          binutils-mipsel-linux-gnu \
          flex \
          bison \
          libgmp-dev \
          libmpfr-dev \
          libmpc-dev \
          texinfo
        
        # Clonar y compilar PSXSDK
        echo "ðŸ“¥ Clonando PSXSDK..."
        git clone https://github.com/psxdev/psxsdk.git
        cd psxsdk
        make
        sudo make install
        cd ..
        
        # Configurar variables de entorno
        echo "PSXSDK=/usr/local/psxsdk" >> $GITHUB_ENV
        echo "PATH=/usr/local/psxsdk/bin:$PATH" >> $GITHUB_ENV
        
        echo "âœ… PSXSDK instalado"

    # PASO 3: Compilar herramientas de assets (si existen)
    - name: ðŸ”§ Build asset tools
      run: |
        echo "ðŸ”§ COMPILANDO HERRAMIENTAS DE ASSETS..."
        
        # Verificar quÃ© herramientas tenemos
        echo "ðŸ“ Contenido de tools/:"
        find tools/ -type f 2>/dev/null | head -20 || echo "No hay tools/"
        
        # Compilar img2tim si existe
        if [ -f "tools/img2tim.c" ]; then
          echo "ðŸ”¨ Compilando img2tim..."
          gcc -O2 -lm tools/img2tim.c -o tools/img2tim
          chmod +x tools/img2tim
        fi
        
        # Compilar funkintimpak si existe
        if [ -f "tools/funkintimpak.c" ]; then
          echo "ðŸ”¨ Compilando funkintimpak..."
          gcc -O2 -lm tools/funkintimpak.c -o tools/funkintimpak
          chmod +x tools/funkintimpak
        fi
        
        # Compilar vagconv si existe
        if [ -f "tools/vagconv.c" ]; then
          echo "ðŸ”¨ Compilando vagconv..."
          gcc -O2 -lm tools/vagconv.c -o tools/vagconv
          chmod +x tools/vagconv
        fi
        
        echo "âœ… Herramientas compiladas:"
        ls -la tools/ 2>/dev/null || echo "No hay herramientas"

    # PASO 4: Procesar assets (segÃºn COMPILE.md)
    - name: ðŸŽ¨ Process assets
      if: ${{ github.event.inputs.build_type == 'full' }}
      run: |
        echo "ðŸŽ¨ PROCESANDO ASSETS (segÃºn COMPILE.md)..."
        
        # Crear estructura de directorios
        mkdir -p iso/ASSETS
        
        # Buscar y convertir assets segÃºn la documentaciÃ³n
        echo "ðŸ” Buscando assets fuente..."
        
        # Convertir PNG a TIM (formato requerido por PSXSDK)
        if find assets/ -name "*.png" 2>/dev/null | head -1; then
          echo "ðŸ–¼ï¸ Convirtiendo PNG a TIM..."
          find assets/ -name "*.png" | while read png_file; do
            filename=$(basename "$png_file" .png)
            echo "Converting $filename.png -> TIM"
            
            if [ -f "tools/funkintimpak" ]; then
              tools/funkintimpak "$png_file" "iso/ASSETS/${filename}.TIM"
            elif [ -f "tools/img2tim" ]; then
              tools/img2tim "$png_file" "iso/ASSETS/${filename}.TIM"
            else
              # ConversiÃ³n bÃ¡sica de emergencia
              convert "$png_file" -resize 256x256! "iso/ASSETS/${filename}.TIM" 2>/dev/null || true
            fi
          done
        else
          echo "ðŸ“ Creando asset bÃ¡sico funkin.tim..."
          echo "TIM_PLACEHOLDER" > iso/ASSETS/funkin.tim
        fi
        
        # Procesar audio
        if find assets/ -name "*.wav" 2>/dev/null | head -1; then
          echo "ðŸ”Š Convirtiendo audio..."
          find assets/ -name "*.wav" | while read wav_file; do
            filename=$(basename "$wav_file" .wav)
            echo "Converting $filename.wav -> VAG"
            
            if [ -f "tools/vagconv" ]; then
              tools/vagconv "$wav_file" "iso/ASSETS/${filename}.VAG"
            else
              # ConversiÃ³n con ffmpeg
              ffmpeg -i "$wav_file" -acodec pcm_s16le -ar 22050 "iso/ASSETS/${filename}.VAG" 2>/dev/null || true
            fi
          done
        fi
        
        echo "ðŸ“Š Assets generados:"
        ls -la iso/ASSETS/ || echo "No hay assets"

    # PASO 5: Compilar el juego (EXACTAMENTE como dice COMPILE.md)
    - name: ðŸŽ® Compile game
      run: |
        echo "ðŸŽ® COMPILANDO JUEGO (Makefile.psx)..."
        
        # Configurar entorno PSXSDK
        export PSXSDK=/usr/local/psxsdk
        export PATH=/usr/local/psxsdk/bin:$PATH
        
        echo "ðŸ”§ Entorno PSXSDK:"
        echo "PSXSDK: $PSXSDK"
        echo "PATH: $PATH"
        
        # Verificar que tenemos las librerÃ­as PSX
        echo "ðŸ“š Verificando librerÃ­as PSX..."
        if [ -f "/usr/local/psxsdk/include/libetc.h" ]; then
          echo "âœ… libetc.h encontrado"
        else
          echo "âŒ libetc.h NO encontrado"
          find /usr/local/psxsdk -name "*.h" | head -10
        fi
        
        # CompilaciÃ³n EXACTA segÃºn COMPILE.md
        echo "ðŸš€ Ejecutando: make -f Makefile.psx"
        make -f Makefile.psx clean
        make -f Makefile.psx
        
        # Verificar resultados
        echo "ðŸ“Š Resultados de compilaciÃ³n:"
        if [ -f "PSXFNKN.BIN" ]; then
          echo "âœ… PSXFNKN.BIN creado exitosamente!"
          ls -lh PSXFNKN.BIN
          # Copiar a ISO
          cp PSXFNKN.BIN iso/PSXFNKN.BIN
        else
          echo "âŒ PSXFNKN.BIN no se creÃ³"
          echo "Buscando archivos binarios..."
          find . -name "*.BIN" -o -name "*.bin" -o -name "*.ELF" | head -10
          exit 1
        fi

    # PASO 6: Preparar ISO (estructura requerida por PSX)
    - name: ðŸ“€ Prepare ISO structure
      run: |
        echo "ðŸ“€ PREPARANDO ESTRUCTURA ISO..."
        
        # Asegurar que el ejecutable estÃ© en lugar correcto
        if [ ! -f "iso/PSXFNKN.BIN" ] && [ -f "PSXFNKN.BIN" ]; then
          cp PSXFNKN.BIN iso/PSXFNKN.BIN
        fi
        
        # Crear SYSTEM.CNF (requerido para boot PSX)
        echo "ðŸ“ Creando SYSTEM.CNF..."
        cat > iso/SYSTEM.CNF << 'EOF'
BOOT = cdrom:\PSXFNKN.BIN;1
TCB = 4
EVENT = 10
STACK = 801FFFF0
EOF
        
        # Verificar estructura final
        echo "ðŸ“ Estructura ISO final:"
        ls -la iso/
        echo "---"
        find iso/ -type f

    # PASO 7: Crear imagen ISO
    - name: ðŸ”¥ Create PSX ISO
      run: |
        echo "ðŸ”¥ CREANDO IMAGEN ISO BOOTEABLE..."
        
        # Crear ISO para PSX
        mkisofs -o PSXFunkin.iso \
          -sysid "PLAYSTATION" \
          -volid "PSXFNKN" \
          -V "PSXFNKN" \
          -J -r -l \
          iso/
        
        # Verificar ISO
        if [ -f "PSXFunkin.iso" ]; then
          echo "ðŸŽ‰ âœ… ISO CREADO EXITOSAMENTE!"
          echo "ðŸ“ TamaÃ±o: $(du -h PSXFunkin.iso | cut -f1)"
          echo "ðŸ” InformaciÃ³n del ISO:"
          file PSXFunkin.iso
        else
          echo "âŒ ERROR: No se pudo crear ISO"
          exit 1
        fi

    # PASO 8: VerificaciÃ³n final
    - name: âœ… Final verification
      run: |
        echo " "
        echo "ðŸŽ¯ BUILD COMPLETADO - PSXFUNKIN BY CUCKYDEV"
        echo "==========================================="
        echo "ðŸ“¦ Archivos generados:"
        echo "   - PSXFunkin.iso (Imagen PSX booteable)"
        echo "   - PSXFNKN.BIN (Ejecutable principal)" 
        echo "   - iso/ASSETS/ (Assets del juego)"
        echo " "
        echo "ðŸš€ CÃ³mo usar:"
        echo "   1. Descarga el artifact 'psx-funkin'"
        echo "   2. Abre PSXFunkin.iso en DuckStation, ePSXe, etc."
        echo "   3. Â¡Disfruta de FNF en PSX!"
        echo " "
        echo "ðŸ“ Notas:"
        echo "   - Build oficial segÃºn COMPILE.md de CuckyDev"
        echo "   - Usa PSXSDK (no PsyQ)"
        echo "   - Assets en formato TIM/VAG"
        echo " "

    # PASO 9: Subir artifacts
    - name: â¬†ï¸ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: psx-funkin
        path: |
          PSXFunkin.iso
          PSXFNKN.BIN
          iso/
        retention-days: 30
