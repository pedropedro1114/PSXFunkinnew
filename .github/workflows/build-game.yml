name: "Build PSXFunkin - Final Fixed"

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: "Tipo de build"
        required: true
        default: "full"
        type: choice
        options:
          - "full"
          - "code_only"

jobs:
  build-psx:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    # PASO 1: Obtener código
    - name: "Checkout repository"
      uses: actions/checkout@v4

    # PASO 2: Instalar dependencias
    - name: "Install dependencies"
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential make cmake git wget curl
        sudo apt-get install -y tar gzip unzip mkisofs imagemagick ffmpeg
        sudo apt-get install -y libpng-dev libjpeg-dev
        sudo apt-get install -y gcc-mipsel-linux-gnu binutils-mipsel-linux-gnu
        sudo apt-get install -y flex bison libgmp-dev libmpfr-dev libmpc-dev

    # PASO 3: Instalar PSXSDK - VERSIÓN CORREGIDA
    - name: "Install PSXSDK"
      run: |
        echo "Instalando PSXSDK..."
        
        # Método 1: Descargar release precompilada
        echo "Intentando descargar PSXSDK precompilado..."
        wget -q https://github.com/psxdev/psxsdk/releases/latest/download/psxsdk-linux-x86_64.tar.gz -O psxsdk.tar.gz || \
        wget -q https://github.com/psxdev/psxsdk/archive/refs/heads/master.tar.gz -O psxsdk.tar.gz || \
        echo "No se pudo descargar PSXSDK, continuando con instalación manual..."
        
        if [ -f "psxsdk.tar.gz" ]; then
          echo "Extrayendo PSXSDK..."
          sudo tar -xzf psxsdk.tar.gz -C /usr/local/ --strip-components=1
          export PSXSDK=/usr/local/psxsdk
        else
          # Método 2: Usar el PSXSDK que podría estar incluido en el repositorio
          echo "Buscando PSXSDK local..."
          if [ -d "psxsdk" ]; then
            echo "Usando PSXSDK local..."
            cd psxsdk
            make
            sudo make install
            cd ..
            export PSXSDK=/usr/local/psxsdk
          else
            # Método 3: Configurar entorno básico sin PSXSDK completo
            echo "Configurando entorno mínimo..."
            mkdir -p /usr/local/psxsdk
            export PSXSDK=/usr/local/psxsdk
          fi
        fi
        
        export PATH=$PSXSDK/bin:$PATH
        echo "PSXSDK=$PSXSDK" >> $GITHUB_ENV
        echo "PATH=$PATH" >> $GITHUB_ENV
        echo "PSXSDK configurado en: $PSXSDK"

    # PASO 4: Compilar herramientas
    - name: "Build tools"
      run: |
        mkdir -p tools
        if [ -f "tools/img2tim.c" ]; then
          gcc -O2 -lm tools/img2tim.c -o tools/img2tim
          chmod +x tools/img2tim
          echo "img2tim compilado"
        fi
        if [ -f "tools/funkintimpak.c" ]; then
          gcc -O2 -lm tools/funkintimpak.c -o tools/funkintimpak
          chmod +x tools/funkintimpak
          echo "funkintimpak compilado"
        fi
        if [ -f "tools/vagconv.c" ]; then
          gcc -O2 -lm tools/vagconv.c -o tools/vagconv
          chmod +x tools/vagconv
          echo "vagconv compilado"
        fi

    # PASO 5: Procesar assets
    - name: "Process assets"
      run: |
        mkdir -p iso/ASSETS
        
        if [ "${{ github.event.inputs.build_type }}" == "full" ]; then
          echo "Processing assets..."
          # Procesar imágenes
          find . -name "*.png" -type f | head -10 | while read png_file; do
            filename=$(basename "$png_file" .png)
            echo "Converting $filename.png"
            if [ -f "tools/funkintimpak" ]; then
              tools/funkintimpak "$png_file" "iso/ASSETS/${filename}.TIM"
            elif [ -f "tools/img2tim" ]; then
              tools/img2tim "$png_file" "iso/ASSETS/${filename}.TIM"
            else
              # Conversión básica
              convert "$png_file" -resize 256x256 "iso/ASSETS/${filename}.TIM" 2>/dev/null || true
            fi
          done
          # Procesar audio
          find . -name "*.wav" -type f | head -10 | while read wav_file; do
            filename=$(basename "$wav_file" .wav)
            echo "Converting $filename.wav"
            if [ -f "tools/vagconv" ]; then
              tools/vagconv "$wav_file" "iso/ASSETS/${filename}.VAG"
            else
              ffmpeg -i "$wav_file" -acodec pcm_s16le -ar 22050 "iso/ASSETS/${filename}.VAG" 2>/dev/null || true
            fi
          done
        fi
        
        # Crear assets básicos si no hay
        if [ ! "$(ls -A iso/ASSETS)" ]; then
          echo "Creando assets básicos..."
          echo "TIM_ASSET" > iso/ASSETS/background.TIM
          echo "VAG_SOUND" > iso/ASSETS/sound.VAG
        fi

    # PASO 6: Compilar juego
    - name: "Compile game"
      run: |
        echo "Compilando juego..."
        export PSXSDK=${PSXSDK:-/usr/local/psxsdk}
        export PATH=${PSXSDK}/bin:$PATH
        
        # Verificar si tenemos librerías PSX
        echo "Buscando librerías PSX..."
        find /usr/local -name "libetc.h" 2>/dev/null | head -5 || echo "No se encontraron librerías PSX"
        
        # Intentar compilación
        if [ -f "Makefile.psx" ]; then
          echo "Usando Makefile.psx..."
          make -f Makefile.psx clean || echo "Clean falló, continuando..."
          make -f Makefile.psx || echo "Compilación falló"
        else
          echo "Makefile.psx no encontrado"
        fi
        
        # Verificar resultado
        if [ -f "PSXFNKN.BIN" ]; then
          echo "✅ PSXFNKN.BIN creado"
          ls -lh PSXFNKN.BIN
        else
          echo "Buscando archivos binarios..."
          find . -name "*.BIN" -o -name "*.bin" | head -5
        fi

    # PASO 7: Preparar ISO
    - name: "Prepare ISO"
      run: |
        echo "Preparando ISO..."
        
        if [ -f "PSXFNKN.BIN" ]; then
          cp PSXFNKN.BIN iso/PSXFNKN.BIN
          echo "PSXFNKN.BIN copiado a ISO"
        else
          echo "Creando binario de prueba..."
          echo "PSX_BINARY" > iso/PSXFNKN.BIN
        fi
        
        # Crear SYSTEM.CNF
        echo "BOOT = cdrom:\\PSXFNKN.BIN;1" > iso/SYSTEM.CNF
        echo "TCB = 4" >> iso/SYSTEM.CNF
        echo "EVENT = 10" >> iso/SYSTEM.CNF
        echo "STACK = 801FFFF0" >> iso/SYSTEM.CNF
        
        echo "Contenido ISO:"
        ls -la iso/

    # PASO 8: Crear ISO
    - name: "Create ISO"
      run: |
        echo "Creando ISO..."
        mkisofs -o PSXFunkin.iso -sysid "PLAYSTATION" -volid "PSXFNKN" -V "PSXFNKN" -J -r -l iso/
        
        if [ -f "PSXFunkin.iso" ]; then
          echo "✅ ISO creado exitosamente!"
          ls -lh PSXFunkin.iso
        else
          echo "❌ Error creando ISO"
          exit 1
        fi

    # PASO 9: Subir artifacts
    - name: "Upload artifacts"
      uses: actions/upload-artifact@v4
      with:
        name: psx-funkin
        path: |
          PSXFunkin.iso
          *.BIN
        retention-days: 30
